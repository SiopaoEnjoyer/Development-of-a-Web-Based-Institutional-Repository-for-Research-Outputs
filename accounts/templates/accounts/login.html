{% extends "research/base_no_header.html" %}
{% load static %}
{% block title %}Login{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'accounts/css/auth_common.css' %}">
<link rel="stylesheet" href="{% static 'accounts/css/verification_modal.css' %}">
<link rel="stylesheet" href="{% static 'accounts/css/password_toggle.css' %}">
<link rel="stylesheet" href="{% static 'research/css/toast_notifications.css' %}">
{% endblock %}

{% block messages %}
<!-- Override base template messages - use toast notifications instead -->
<div class="django-messages" style="display: none;">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
</div>
{% endblock messages %}

{% block content %}
<div class="auth-bg-container">
    <div class="card auth-card shadow-lg" id="loginCard">
        <div class="card-body">
            <div class="auth-logo">
                <img src="{% static 'research/img/logo.png' %}" alt="Trinity Logo">
            </div>

            <h3 class="auth-title">Sign In</h3>
            <p class="auth-subtitle">Access your research account</p>

            <form method="POST" id="loginForm" novalidate>
                {% csrf_token %}
                
                <div class="mb-3">
                    <label class="form-label">
                        Email Address<span class="required-asterisk">*</span>
                    </label>
                    <input type="email" 
                           class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                           name="email" 
                           id="email"
                           placeholder="your.email@example.com"
                           value="{{ form.email.value|default:'' }}"
                           required>
                    <div class="invalid-feedback" id="emailError">
                        {% if form.email.errors %}
                            {{ form.email.errors.0 }}
                        {% else %}
                            Please enter a valid email address
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">
                        Password<span class="required-asterisk">*</span>
                    </label>
                    <input type="password" 
                           class="form-control {% if form.password.errors %}is-invalid{% endif %}" 
                           name="password"
                           id="password"
                           placeholder="Enter your password"
                           required>
                    <div class="invalid-feedback" id="passwordError">
                        {% if form.password.errors %}
                            {{ form.password.errors.0 }}
                        {% else %}
                            Please enter your password
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3 text-end">
                    <a href="{% url 'accounts:forgot_password' %}" class="text-decoration-none" style="color: var(--theme-green); font-weight: 600; font-size: 0.9rem; transition: all 0.3s ease;">
                        <i class="bi bi-question-circle me-1"></i>Forgot Password?
                    </a>
                </div>

                <div class="required-note">
                    <i class="bi bi-info-circle"></i>
                    <span><span class="required-asterisk">*</span> Required field</span>
                </div>

                <button type="submit" class="btn btn-success w-100 mt-3" id="loginButton">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Login
                </button>

                <div class="auth-footer">
                    <p class="auth-footer-text">Don't have an account?</p>
                    <a href="{% url 'accounts:register' %}" class="auth-footer-link">
                        Create an account <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Verification Modal -->
{% include 'accounts/verification_modal.html' %}

<script src="{% static 'research/js/toast_notifications.js' %}"></script>
<script src="{% static 'accounts/js/auth_common.js' %}"></script>
<script src="{% static 'accounts/js/login.js' %}"></script>
<script src="{% static 'accounts/js/verification_modal.js' %}"></script>
<script src="{% static 'accounts/js/password_toggle.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // ===== PREVENT DOUBLE SUBMISSION =====
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        let isSubmitting = false;
        
        loginForm.addEventListener('submit', function(e) {
            // Prevent double submission
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }
            
            // Validate form
            if (!loginForm.checkValidity()) {
                e.preventDefault();
                loginForm.classList.add('was-validated');
                return false;
            }
            
            // Set submitting flag
            isSubmitting = true;
            
            // Store original button content
            const originalContent = loginButton.innerHTML;
            
            // Disable button and show loading state
            loginButton.disabled = true;
            loginButton.style.cursor = 'not-allowed';
            loginButton.innerHTML = `
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Signing In...
            `;
            
            // Add visual feedback
            loginButton.style.opacity = '0.7';
            
            // Fallback: re-enable if still on page after 8 seconds (server error)
            setTimeout(() => {
                if (document.getElementById('loginForm')) {
                    loginButton.disabled = false;
                    loginButton.style.cursor = 'pointer';
                    loginButton.innerHTML = originalContent;
                    loginButton.style.opacity = '1';
                    isSubmitting = false;
                }
            }, 8000);
        });
        
        // Initialize verification modal if needed
        var shouldShowModal = ('{{ request.session.show_verification_modal }}' === 'True');
        var verificationEmail = "{{ request.session.verification_email|default:''|escapejs }}";
        
        console.log('Should show modal:', shouldShowModal);
        console.log('Has form errors:', {{ form.errors|yesno:"true,false" }});
        
        // Only show error toasts if NOT showing verification modal
        if (!shouldShowModal) {
            {% if form.errors %}
                console.log('Processing form errors...');
                
                // Show non-field errors (like "Invalid credentials")
                {% if form.non_field_errors %}
                    {% for error in form.non_field_errors %}
                        console.log('Non-field error:', "{{ error|escapejs }}");
                        showError("{{ error|escapejs }}", 4000);
                    {% endfor %}
                {% else %}
                    // If no non-field errors but has field errors, show generic message
                    {% if form.email.errors or form.password.errors %}
                        console.log('Field errors detected');
                        showError("Invalid email or password. Please try again.", 4000);
                    {% endif %}
                {% endif %}
            {% endif %}
        }
        
        // Initialize verification modal if needed
        if (shouldShowModal && verificationEmail) {
            console.log('Initializing verification modal...');
            initVerificationModal({
                showModal: true,
                email: verificationEmail,
                csrfToken: "{{ csrf_token }}",
                verifyUrl: "{% url 'accounts:verify_email_ajax' %}",
                resendUrl: "{% url 'accounts:resend_verification' %}",
                maxAttempts: 10
            });
        }
    });
</script>
{% endblock %}