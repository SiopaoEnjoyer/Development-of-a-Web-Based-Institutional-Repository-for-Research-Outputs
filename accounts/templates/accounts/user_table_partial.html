{% if profiles %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th style="width: 20%;" class="sortable" data-sort="name">Name</th>
                    <th style="width: 17%;" class="sortable" data-sort="email">Email</th>
                    <th style="width: 13%;" class="sortable" data-sort="role">Role</th>
                    <th style="width: 13%;">Status</th>
                    <th style="width: 11%;">Consent</th>
                    <th style="width: 11%;">School Year</th>
                    <th style="width: 8%;" class="sortable" data-sort="age">Age</th>
                    <th style="width: 12%;">Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for profile in profiles %}
                <tr>
                    <td>
                        <strong>
                            {{ profile.pending_last_name }}, {{ profile.pending_first_name }}{% if profile.pending_middle_initial %} {{ profile.pending_middle_initial }}.{% endif %}{% if profile.pending_suffix %} {{ profile.pending_suffix }}{% endif %}
                        </strong>
                    </td>
                    <td>{{ profile.user.email }}</td>
                    <td>
                        <span class="role-text">
                            {{ profile.user.get_role_display }}
                        </span>
                    </td>
                    <td>
                        {% if profile.is_approved %}
                            <span class="status-text status-approved">
                                <i class="bi bi-check-circle"></i> Approved
                            </span>
                        {% else %}
                            <span class="status-text status-pending">
                                <i class="bi bi-clock"></i> Pending
                            </span>
                        {% endif %}
                        <br>
                        {% if profile.user.is_active %}
                            <span class="status-text status-active" style="margin-top: 4px;">
                                <i class="bi bi-power"></i> Active
                            </span>
                        {% else %}
                            <span class="status-text status-inactive" style="margin-top: 4px;">
                                <i class="bi bi-x-circle"></i> Inactive
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if profile.consent_status == 'consented' %}
                            <span class="consent-text consent-consented">
                                <i class="bi bi-check-circle"></i> Consented
                            </span>
                        {% elif profile.consent_status == 'pending_approval' %}
                            <span class="consent-text consent-pending">
                                <i class="bi bi-clock"></i> Pending
                            </span>
                        {% else %}
                            <span class="consent-text consent-not-consented">
                                <i class="bi bi-x-circle"></i> Not Consented
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if profile.pending_G11 and profile.pending_G12 %}
                            <span class="batch-text" style="display: block; margin-bottom: 2px;">G11: {{ profile.pending_G11 }}</span>
                            <span class="batch-text" style="display: block;">G12: {{ profile.pending_G12 }}</span>
                        {% elif profile.pending_G12 %}
                            <span class="batch-text">{{ profile.pending_G12 }}</span>
                        {% elif profile.pending_G11 %}
                            <span class="batch-text">{{ profile.pending_G11 }}</span>
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if profile.user.age %}
                            {{ profile.user.age }} yrs
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <button 
                                type="button" 
                                class="btn btn-warning btn-sm"
                                onclick="openEditModal({{ profile.id }})"
                            >
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <form method="post" action="{% url 'accounts:toggle_user_active' profile.id %}" style="display: inline;" onsubmit="return handleToggleActive(event, this, '{{ profile.pending_first_name }} {{ profile.pending_last_name }}', {{ profile.user.is_active|yesno:'true,false' }})">
                                {% csrf_token %}
                                <button type="submit" class="btn {% if profile.user.is_active %}btn-secondary{% else %}btn-success{% endif %} btn-sm">
                                    <i class="bi bi-power"></i> {% if profile.user.is_active %}Deactivate{% else %}Activate{% endif %}
                                </button>
                            </form>
                            <form method="post" action="{% url 'accounts:delete_user' profile.id %}" style="display: inline;" onsubmit="return handleDeleteUser(event, this, '{{ profile.pending_last_name }}, {{ profile.pending_first_name }}')">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if current_search %}&search={{ current_search }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}{% if current_approval %}&approval={{ current_approval }}{% endif %}{% if current_consent %}&consent={{ current_consent }}{% endif %}{% if current_batch %}&batch={{ current_batch }}{% endif %}">
                <i class="bi bi-chevron-double-left"></i>
            </a>
            <a href="?page={{ page_obj.previous_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}{% if current_approval %}&approval={{ current_approval }}{% endif %}{% if current_consent %}&consent={{ current_consent }}{% endif %}{% if current_batch %}&batch={{ current_batch }}{% endif %}">
                <i class="bi bi-chevron-left"></i>
            </a>
        {% endif %}

        <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}{% if current_approval %}&approval={{ current_approval }}{% endif %}{% if current_consent %}&consent={{ current_consent }}{% endif %}{% if current_batch %}&batch={{ current_batch }}{% endif %}">
                <i class="bi bi-chevron-right"></i>
            </a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}{% if current_approval %}&approval={{ current_approval }}{% endif %}{% if current_consent %}&consent={{ current_consent }}{% endif %}{% if current_batch %}&batch={{ current_batch }}{% endif %}">
                <i class="bi bi-chevron-double-right"></i>
            </a>
        {% endif %}
    </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <p class="mb-0">No users found matching your filters.</p>
    </div>
{% endif %}

<script>
// Handle toggle active with confirmation and toast
function handleToggleActive(event, form, userName, isActive) {
    event.preventDefault();
    const action = isActive ? 'deactivate' : 'activate';
    
    if (confirm(`Are you sure you want to ${action} ${userName}?`)) {
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                showSuccess(`User ${isActive ? 'deactivated' : 'activated'} successfully!`);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showError('Failed to update user status.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('An error occurred. Please try again.');
        });
    }
    return false;
}

// Handle delete with confirmation and toast
function handleDeleteUser(event, form, userName) {
    event.preventDefault();
    
    if (confirm(`Are you sure you want to delete ${userName}? This cannot be undone.`)) {
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                showSuccess('User deleted successfully!');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showError('Failed to delete user.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('An error occurred. Please try again.');
        });
    }
    return false;
}
</script>